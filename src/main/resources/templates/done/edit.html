<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script>
<script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.polyfills.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css" rel="stylesheet" type="text/css" />

  <head>
    <meta charset="UTF-8">
    <title>できたことリスト・編集</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
  </head>

  <body>
    <div>
      <header th:replace="~{fragments/header::header}"></header>
    </div>

    <div class="sidebar" th:replace="~{fragments/sidebar::sidebar}"></div>

    <div class="task-container">
      <div class="reference-todo-container">
        <div class="date-label">
          <p th:text="${todoResponseDto.formattedDate}"></p>
        </div>

        <!-- 登録されていない場合 -->
        <th:block th:if="${!todoResponseDto.hasContent}">
          <div class="empty-content">
            <p>この日の<span>やることリスト</span>は登録されていません。</p>
          </div>
        </th:block>

        <!-- 登録されている場合 -->
        <th:block th:if="${todoResponseDto.hasContent}">
          <div class="content-inner">
            <div class="inner-title">【参考】やることリスト</div>
            <table class="view-table">
              <tr th:each="content, iterStat : ${todoResponseDto.contentList}">
                <div th:if="${content != null and !#strings.isEmpty(content)}">
                  <th scope="row" class="index-th"
                      th:text="${iterStat.index + 1}"></th>
                  <td th:text="${todoResponseDto.contentList[__${iterStat.index}__]}"></td>
                </div>
              </tr>
            </table>
          </div>
        </th:block>
      </div>

      <div class="done-edit-form-container">
        <div class="back-indicator">
          <a th:href="@{/done/{date}(date=${doneRequestDto.date})}">
            <img th:src="@{/image/back-icon.svg}" alt="戻る">
            <span>戻る</span>
          </a>
        </div>

        <form id="doneForm" class="form-group"
              th:action="@{/done/edit/{date}(date=${doneRequestDto.date})}"
              th:object="${doneRequestDto}" method="post">

          <div class="form-title">できたことリスト</div>

          <div class="notice-area">
            <div class="notice-message">
              <p th:text="#{task.edit.notice1}"></p>
              <p th:if="${doneRequestDto.idList[0] != 0}"
                 th:text="#{task.edit.notice2}"></p>
              <p th:text="#{tag.input.notice}"></p>
            </div>
          </div>

          <table id="variable-table" class="variable-input-table">
            <tr>
              <th scope="row" class="task-th">日付</th>
              <td class="blank-cell"></td>
              <td>
                <input type="date" class="input-date-area"
                       th:field="*{date}" required/>
              </td>
            </tr>
            <tr>
              <td colspan="2"></td>
              <td colspan="4">
                <div class="error-message"
                     th:if="${#fields.hasErrors('date')}"
                     th:errors="*{date}"></div>
              </td>
            </tr>
            <tr class="blank-row"></tr>
            <tbody th:each="id, iterStat : *{idList}"
                   data-row-id="${iterStat.index}">
              <tr class="content-row">
                <th scope="row" class="task-th"
                    th:text="'内容 ' + ${iterStat.index + 1}"></th>
                <td class="blank-cell">
                  <input type="hidden"
                         th:field="*{idList[__${iterStat.index}__]}" />
                </td>
                <td colspan="3">
                  <input type="text" class="input-area"
                         th:field="*{contentList[__${iterStat.index}__]}"
                         th:placeholder="#{task.content.placeholder}" />
                </td>

                <td class="delete-check-td">
                  <!-- 登録済みレコードの場合は削除チェックボックスを表示　-->
                  <label class="delete-check-area"
                         th:if="*{idList[__${iterStat.index}__] > 0}">
                    <input type="checkbox" class="delete-check"
                           th:field="*{deletableList[__${iterStat.index}__]}" value="true" />
                    <input type="hidden"
                           th:field="*{deletableList[__${iterStat.index}__]}" value="false" />
                    <div class="delete-icon-area">
                      <img th:src="@{/image/delete-icon.svg}" class="delete-icon">
                    </div>
                  </label>
                  <!-- JSで追加した行の場合は削除ボタンを表示 -->
                  <button type="button" class="remove-row-button"
                          th:unless="*{idList[__${iterStat.index}__] > 0}
                              or ${iterStat.index == 0}">×</button>
                </td>
              </tr>
              <tr class="time-row">
                <th scope="row" class="task-th"
                    th:text="'学習時間 ' + ${iterStat.index + 1}"></th>
                <td class="blank-cell"></td>
                <td class="input-time-area">
                  <input type="number" class="input-area"
                         th:field="*{hoursList[__${iterStat.index}__]}"
                         th:placeholder="#{hours.placeholder}"
                         min="0" max="24" value="0" />
                </td>
                <td class="time-unit-cell">
                  <span>時間</span>
                </td>
                <td class="input-time-area">
                  <input type="number" class="input-area"
                         th:field="*{minutesList[__${iterStat.index}__]}"
                         th:placeholder="#{minutes.placeholder}"
                         min="0" max="59" value="0" />
                </td>
                <td class="time-unit-cell">
                  <span>分</span>
                </td>
              </tr>
              <tr class="memo-row">
                <th scope="row" class="task-th"
                    th:text="'メモ ' + ${iterStat.index + 1}"></th>
                <td class="blank-row"></td>
                <td colspan="4" class="done-memo-area">
                  <textarea class="input-done-memo-area"
                            th:field="*{memoList[__${iterStat.index}__]}"
                            th:placeholder="#{done.memo.placeholder}" ></textarea>
                </td>
              </tr>
              <tr class="tag-row">
                <th scope="row" class="task-th"
                    th:text="'タグ ' + ${iterStat.index + 1}"></th>
                <td class="blank-cell"></td>
                <td colspan="4">
                  <input type="text" class="tags-input"
                         th:id="'tags-input-' + ${iterStat.index}"
                         th:field="*{tagsList[__${iterStat.index}__]}" />
                </td>
              </tr>
              <tr th:if="${#fields.hasErrors('contentList')}">
                <td class="error-message-td"></td>
                <td class="blank-cell"></td>
                <td colspan="4">
                  <div class="error-message" th:errors="*{contentList}"></div>
                </td>
              </tr>
              <tr th:if="${#fields.hasErrors('hoursList')}">
                <td class="error-message-td"></td>
                <td class="blank-cell"></td>
                <td colspan="4">
                  <div class="error-message" th:errors="*{hoursList}"></div>
                </td>
              </tr>
              <tr th:if="${#fields.hasErrors('minutesList')}">
                <td class="error-message-td"></td>
                <td class="blank-cell"></td>
                <td colspan="4">
                  <div class="error-message" th:errors="*{minutesList}"></div>
                </td>
              </tr>
              <tr th:if="${#fields.hasErrors('hoursList[' + iterStat.index + ']')}">
                <td class="error-message-td"></td>
                <td class="blank-cell"></td>
                <td colspan="4">
                  <div class="error-message"
                       th:errors="*{hoursList[__${iterStat.index}__]}"></div>
                </td>
              </tr>
              <tr th:if="${#fields.hasErrors('memoList')}">
                <td class="error-message-td"></td>
                <td class="blank-cell"></td>
                <td colspan="4">
                  <div class="error-message" th:errors="*{memoList}"></div>
                </td>
              </tr>
              <tr class="border-row">
                <td colspan="6">
                  <div class="border-line"></div>
                </td>
              </tr>
            </tbody>
          </table>

          <div class="add-button-area">
            <button type="button" id="add-row" class="add-button">＋</button>
          </div>

          <div class="button-area">
            <button type="submit" class="register-button">登録</button>
          </div>
        </form>

        <!-- submit時に削除チェックが入っている場合はダイアログを表示 -->
        <script th:inline="javascript">
          /*<![CDATA[*/
              const deleteConfirmMessage = /*[[#{delete.confirm}]]*/;

              document.getElementById("doneForm").addEventListener("submit", function(e) {
                  const hasDelete = [...document.querySelectorAll(".delete-check")]
                      .some(cb => cb.checked);

                  if(hasDelete && !confirm(deleteConfirmMessage)) {
                      e.preventDefault();
                  }
              });
          /*]]>*/
        </script>
      </div>
    </div>

    <!-- 行追加・削除する関数を呼び出す -->
    <script th:src="@{/js/done-add-tbody.js}"></script>
    <script th:inline="javascript">
      /*<![CDATA[*/
          const contentPlaceholder = /*[[#{task.content.placeholder}]]*/;
          const hoursPlaceholder = /*[[#{hours.placeholder}]]*/;
          const minutesPlaceholder = /*[[#{minutes.placeholder}]]*/;
          const memoPlaceholder = /*[[#{done.memo.placeholder}]]*/;

          initDoneAddTbody();
      /*]]>*/
    </script>

    <!-- Tagifyの初期化関数を呼び出す -->
    <script th:src="@{/js/tagify.js}"></script>
    <script th:inline="javascript">
      /*<![CDATA[*/
          const tagNameList = /*[[${tagNameList}]]*/ [];
          initAllTagify();
      /*]]>*/
    </script>
  </body>
</html>